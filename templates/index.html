<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Drone Path Predictor</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    height: 100vh;
    overflow: hidden;
    background: #f5f5f5;
  }

  .app-container {
    display: flex;
    height: 100vh;
  }

  /* Sidebar Styles */
  .sidebar {
    width: 380px;
    background: white;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    z-index: 1000;
  }

  .sidebar-header {
    background: rgba(0, 0, 0, 0.75);
    color: white;
    padding: 25px 20px;
    flex-shrink: 0;
  }

  .sidebar-header h1 {
    font-size: 1.6em;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .sidebar-header p {
    font-size: 0.9em;
    opacity: 0.9;
  }

  .sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }

  .sidebar-footer {
    padding: 20px;
    background: #f8f9fa;
    border-top: 1px solid #e0e0e0;
    flex-shrink: 0;
  }

  /* Alert Styles */
  .alert {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 15px;
    display: none;
    font-size: 0.9em;
  }

  .alert.active {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .alert-error {
    background: #fee;
    color: #c33;
    border: 1px solid #fcc;
  }

  .alert-success {
    background: #efe;
    color: #3c3;
    border: 1px solid #cfc;
  }

  /* Section Styles */
  .section {
    margin-bottom: 25px;
  }

  .section-title {
    font-size: 0.85em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #666;
    margin-bottom: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* Drone Card Styles */
  .drone-card {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 12px;
    transition: all 0.2s ease;
    position: relative;
  }

  .drone-card:hover {
    border-color: #667eea;
    background: #f8f9ff;
  }

  .drone-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
  }

  .drone-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .drone-badge {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.9em;
  }

  .drone-name {
    font-weight: 600;
    color: #333;
    font-size: 1em;
  }

  .remove-btn {
    background: none;
    border: none;
    color: #dc3545;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 1.2em;
    transition: background 0.2s;
  }

  .remove-btn:hover {
    background: #fee;
  }

  .input-group {
    margin-bottom: 10px;
  }

  .input-group label {
    display: block;
    font-size: 0.8em;
    color: #666;
    margin-bottom: 5px;
    font-weight: 500;
  }

  .input-group input {
    width: 100%;
    padding: 9px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9em;
    transition: all 0.2s;
    background: white;
  }

  .input-group input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .input-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  /* Button Styles */
  .btn {
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    font-size: 0.95em;
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    width: 100%;
  }

  .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .btn:active {
    transform: translateY(0);
  }

  .btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .btn-secondary {
    background: white;
    color: #667eea;
    border: 2px solid #667eea;
  }

  .btn-secondary:hover {
    background: #667eea;
    color: white;
  }

  .btn-danger {
    background: white;
    color: #dc3545;
    border: 2px solid #dc3545;
  }

  .btn-danger:hover {
    background: #dc3545;
    color: white;
  }

  .button-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-top: 15px;
  }

  /* Loading Styles */
  .loading {
    display: none;
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 15px;
  }

  .loading.active {
    display: block;
  }

  .spinner {
    border: 3px solid #e9ecef;
    border-top: 3px solid #667eea;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 10px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .loading-text {
    font-size: 0.9em;
    color: #666;
  }

  /* Map Container */
  .map-container {
    flex: 1;
    position: relative;
  }

  #map {
    width: 100%;
    height: 100%;
  }

  /* Stats Panel */
  .stats-panel {
    position: absolute;
    top: 20px;
    right: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    padding: 20px;
    min-width: 300px;
    max-width: 350px;
    z-index: 999;
    display: none;
  }

  .stats-panel.active {
    display: block;
  }

  .stats-header {
    font-weight: 600;
    font-size: 1.1em;
    margin-bottom: 15px;
    color: #333;
    display: flex;
    align-items: center;
    gap: 8px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
  }

  .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f5f5f5;
  }

  .stat-row:last-child {
    border-bottom: none;
  }

  .stat-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9em;
    color: #666;
  }

  .stat-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .stat-value {
    font-weight: 600;
    color: #333;
    font-size: 0.9em;
  }

  .stat-total {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 2px solid #e9ecef;
  }

  .stat-total .stat-label {
    font-weight: 600;
    color: #333;
  }

  .stat-total .stat-value {
    font-size: 1.1em;
    color: #667eea;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #999;
  }

  .empty-icon {
    font-size: 3em;
    margin-bottom: 15px;
    opacity: 0.3;
  }

  .empty-text {
    font-size: 0.95em;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .sidebar {
      width: 100%;
      max-width: 100%;
    }

    .app-container {
      flex-direction: column;
    }

    .map-container {
      height: 50vh;
    }

    .stats-panel {
      top: 10px;
      right: 10px;
      left: 10px;
      min-width: auto;
    }
  }

  /* Scrollbar */
  .sidebar-content::-webkit-scrollbar {
    width: 6px;
  }

  .sidebar-content::-webkit-scrollbar-track {
    background: #f1f1f1;
  }

  .sidebar-content::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
  }

  .sidebar-content::-webkit-scrollbar-thumb:hover {
    background: #999;
  }
</style>
</head>
<body>

<div class="app-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>üöÅ Drone Tracker</h1>
      <p>Real-time path prediction</p>
    </div>

    <div class="sidebar-content">
      <div class="alert alert-error" id="error-alert"></div>
      <div class="alert alert-success" id="success-alert"></div>

      <div class="loading" id="loading">
        <div class="spinner"></div>
        <div class="loading-text">Calculating optimal paths...</div>
      </div>

      <div class="section">
        <div class="section-title">
          ‚úàÔ∏è ACTIVE DRONES
        </div>
        <div id="drones-container"></div>
      </div>
    </div>

    <div class="sidebar-footer">
      <button class="btn btn-secondary" id="add-drone-btn">
        ‚ûï Add Drone
      </button>
      <div class="button-group">
        <button class="btn btn-primary" id="predict-btn">
          üéØ Predict
        </button>
        <button class="btn btn-danger" id="clear-btn">
          üóëÔ∏è Clear
        </button>
      </div>
    </div>
  </div>

  <!-- Map Container -->
  <div class="map-container">
    <div id="map"></div>
    
    <!-- Stats Panel -->
    <div class="stats-panel" id="stats-panel">
      <div class="stats-header">
        üìä Flight Statistics
      </div>
      <div id="stats-content"></div>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let droneCount = 0;
  const dronesContainer = document.getElementById('drones-container');
  const addDroneBtn = document.getElementById('add-drone-btn');
  const predictBtn = document.getElementById('predict-btn');
  const clearBtn = document.getElementById('clear-btn');
  const loading = document.getElementById('loading');
  const errorAlert = document.getElementById('error-alert');
  const successAlert = document.getElementById('success-alert');
  const statsPanel = document.getElementById('stats-panel');
  const statsContent = document.getElementById('stats-content');

  // Initialize Leaflet map
  const map = L.map('map').setView([12.9716, 77.5946], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  const polylines = [];
  const markers = [];
  const droneMarkers = [];
  const colors = ['#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];

  function showAlert(type, message) {
    const alert = type === 'error' ? errorAlert : successAlert;
    alert.textContent = message;
    alert.classList.add('active');
    setTimeout(() => alert.classList.remove('active'), 5000);
  }

  function addDroneForm() {
    droneCount++;
    const color = colors[(droneCount - 1) % colors.length];
    const div = document.createElement('div');
    div.className = 'drone-card';
    div.id = `drone-${droneCount}`;
    div.innerHTML = `
      <div class="drone-card-header">
        <div class="drone-info">
          <div class="drone-badge" style="background: ${color};">${droneCount}</div>
          <span class="drone-name">Drone ${droneCount}</span>
        </div>
        <button class="remove-btn" onclick="removeDroneForm(${droneCount})">√ó</button>
      </div>
      <div class="input-group">
        <label>üìç Start Location</label>
        <input type="text" name="from" placeholder="e.g., Indiranagar" />
      </div>
      <div class="input-group">
        <label>üéØ Destination</label>
        <input type="text" name="to" placeholder="e.g., Electronic City" />
      </div>
      <div class="input-row">
        <div class="input-group">
          <label>‚ö° Speed (m/s)</label>
          <input type="number" name="speed" value="15.0" step="0.5" min="0.5" />
        </div>
        <div class="input-group">
          <label>üìè Altitude (m)</label>
          <input type="number" name="altitude" value="50" step="5" min="10" />
        </div>
      </div>
    `;
    dronesContainer.appendChild(div);
  }

  function removeDroneForm(id) {
    const form = document.getElementById(`drone-${id}`);
    if (form) {
      dronesContainer.removeChild(form);
    }
  }

  function clearPolylines() {
    polylines.forEach(line => map.removeLayer(line));
    polylines.length = 0;
  }

  function clearMarkers() {
    markers.forEach(marker => map.removeLayer(marker));
    markers.length = 0;
  }

  function clearDroneMarkers() {
    droneMarkers.forEach(marker => map.removeLayer(marker));
    droneMarkers.length = 0;
  }

  function clearAll() {
    clearPolylines();
    clearMarkers();
    clearDroneMarkers();
    statsPanel.classList.remove('active');
    dronesContainer.innerHTML = '';
    droneCount = 0;
    addDroneForm();
    showAlert('success', 'All data cleared');
  }

  function updateStats(paths, drones) {
    let totalDistance = 0;
    let statsHTML = '';

    paths.forEach((path, index) => {
      let distance = 0;
      for (let i = 1; i < path.length; i++) {
        const [lat1, lon1] = path[i - 1];
        const [lat2, lon2] = path[i];
        distance += calculateDistance(lat1, lon1, lat2, lon2);
      }
      totalDistance += distance;

      const time = (distance / (drones[index].speed || 15)) / 60;
      const color = colors[index % colors.length];

      statsHTML += `
        <div class="stat-row">
          <div class="stat-label">
            <span class="stat-dot" style="background: ${color};"></span>
            Drone ${index + 1}
          </div>
          <div class="stat-value">${distance.toFixed(1)} km ‚Ä¢ ${time.toFixed(0)} min</div>
        </div>
      `;
    });

    statsHTML += `
      <div class="stat-row stat-total">
        <div class="stat-label">Total Distance</div>
        <div class="stat-value">${totalDistance.toFixed(1)} km</div>
      </div>
    `;

    statsContent.innerHTML = statsHTML;
    statsPanel.classList.add('active');
  }

  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  addDroneBtn.addEventListener('click', () => {
    addDroneForm();
  });

  clearBtn.addEventListener('click', () => {
    if (confirm('Clear all drones and paths?')) {
      clearAll();
    }
  });

  predictBtn.addEventListener('click', async () => {
    clearPolylines();
    clearMarkers();
    clearDroneMarkers();
    loading.classList.add('active');
    errorAlert.classList.remove('active');
    successAlert.classList.remove('active');

    const droneForms = document.querySelectorAll('.drone-card');
    const drones = [];

    for (const form of droneForms) {
      const fromPlace = form.querySelector('input[name="from"]').value.trim();
      const toPlace = form.querySelector('input[name="to"]').value.trim();
      const speed = parseFloat(form.querySelector('input[name="speed"]').value);
      const altitude = parseFloat(form.querySelector('input[name="altitude"]').value);

      if (!fromPlace || !toPlace || !speed || speed <= 0) {
        loading.classList.remove('active');
        showAlert('error', 'Please fill all fields with valid values');
        return;
      }

      drones.push({ from: fromPlace, to: toPlace, speed, altitude });
    }

    if (drones.length === 0) {
      loading.classList.remove('active');
      showAlert('error', 'Add at least one drone');
      return;
    }

    try {
      const response = await fetch('/predict_paths', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ drones })
      });

      const data = await response.json();
      loading.classList.remove('active');

      if (data.error) {
        showAlert('error', data.error);
        return;
      }

      showAlert('success', `Paths calculated for ${drones.length} drone(s)`);

      data.paths.forEach((path, index) => {
        const latlngs = path.map(([lat, lon]) => [lat, lon]);
        const color = colors[index % colors.length];
        
        const polyline = L.polyline(latlngs, { 
          color, 
          weight: 3,
          opacity: 0.8
        }).addTo(map);
        polylines.push(polyline);

        const startMarker = L.circleMarker(latlngs[0], {
          radius: 8,
          fillColor: color,
          color: 'white',
          weight: 2,
          fillOpacity: 1
        }).addTo(map);
        startMarker.bindPopup(`<b>Drone ${index + 1} Start</b><br>${drones[index].from}`);
        markers.push(startMarker);

        const endMarker = L.circleMarker(latlngs[latlngs.length - 1], {
          radius: 10,
          fillColor: color,
          color: 'white',
          weight: 3,
          fillOpacity: 1
        }).addTo(map);
        endMarker.bindPopup(`<b>Drone ${index + 1} End</b><br>${drones[index].to}`);
        markers.push(endMarker);

        map.fitBounds(polyline.getBounds());
        animateDrone(latlngs, index, color);
      });

      updateStats(data.paths, drones);

    } catch (err) {
      loading.classList.remove('active');
      showAlert('error', 'Error predicting path');
      console.error(err);
    }
  });

  function animateDrone(path, index, color) {
    const droneIcon = L.divIcon({
      html: `<div style="background: ${color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"></div>`,
      className: '',
      iconSize: [14, 14],
      iconAnchor: [7, 7]
    });

    const marker = L.marker(path[0], { icon: droneIcon }).addTo(map);
    droneMarkers.push(marker);

    let currentSegment = 0;
    let progress = 0;
    const duration = 1500;
    let lastTimestamp = null;

    function interpolate(p1, p2, t) {
      return [
        p1[0] + (p2[0] - p1[0]) * t,
        p1[1] + (p2[1] - p1[1]) * t
      ];
    }

    function step(timestamp) {
      if (!lastTimestamp) lastTimestamp = timestamp;
      const delta = timestamp - lastTimestamp;
      lastTimestamp = timestamp;

      progress += delta / duration;
      if (progress >= 1) {
        progress = 0;
        currentSegment++;
        if (currentSegment >= path.length - 1) {
          marker.setLatLng(path[path.length - 1]);
          return;
        }
      }

      const pos = interpolate(path[currentSegment], path[currentSegment + 1], progress);
      marker.setLatLng(pos);
      requestAnimationFrame(step);
    }

    requestAnimationFrame(step);
  }

  // Initialize with one drone
  addDroneForm();
</script>

</body>
</html>